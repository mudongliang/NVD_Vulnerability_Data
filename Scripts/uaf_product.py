#!/usr/bin/env python

import json
import os

def get_all_datafile():
    json_list = []
    for dirname,folder,files in os.walk("."):
        for filename in files:
            if filename.endswith(".json"):
                json_list.append(filename)
    return json_list

def load(json_file):
    print(json_file)
    uaf_list = []
    with open(json_file) as json_data:  
        data = json.load(json_data)
    #for key in data.keys():
    #    print(key)
    for items in data["CVE_Items"]:
        cve_info = items["cve"]
        #print(cve_info["CVE_data_meta"]["ID"])
        cve_id = cve_info["CVE_data_meta"]["ID"]

        uaf_flag = False
        # check whether it is UAF 
        for cwe in cve_info["problemtype"]["problemtype_data"]:
            for dp in cwe["description"]:
		#print(cve_id,":",dp["value"])
		if dp["value"].find("CWE-416")!=-1 or dp["value"].find("CWE-415")!=-1 :
                    uaf_flag = True
		    #print(cve_id,dp["value"])
		    break
	if not uaf_flag:
		for description_data in cve_info["description"]["description_data"]:
		    if description_data["value"].find("CWE-416")!=-1 or description_data["value"].find("CWE-415")!=-1 :
		    	uaf_flag = True
			#print (cve_id,description_data["value"])
			break
        if not uaf_flag:
            continue
	
	one_cve = [cve_id]
        # record vendor & product_name
        for vendor in cve_info["affects"]["vendor"]["vendor_data"]:
            one_vendor = []
	    one_vendor.append(vendor["vendor_name"])
	    products = []
            for product in vendor["product"]["product_data"]:
                products.append(product["product_name"])
	    one_vendor.append(products)
            one_cve.append(one_vendor)
		  	    
	uaf_list.append(one_cve)

    print len(uaf_list)
    return uaf_list

def write_uaf(file_name,uaf_list):
    for uaf in uaf_list:
	cve_id = uaf.pop(0)
	for vendor in uaf:
	    vendor_name = vendor.pop(0)
	    for product in vendor.pop():
		file_name.write(cve_id)
		file_name.write(" ")
		file_name.write(vendor_name)
		file_name.write(" ")
		file_name.write(product)
		file_name.write("\n")
    return 0
    
# to get all UAFs from json files
# group as [cve_id,[vendor_name ,[product_name..]..]..]..
if __name__ == "__main__":
    json_files = get_all_datafile()
    #json_files = ["nvdcve-1.0-2017.json"]
    res = open("UAFs.txt","a")
    for json_file in json_files:
        res_list = load(json_file)
	print res_list
	write_uaf(res,res_list)
    res.close()
